name: Unit Tests
run-name: ${{ github.actor }} is testing ${{ github.ref }}
on: [push]
jobs:
  UnitTests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get install -y gnulib

      - name: Cache library dependencies
        uses: actions/cache@v3
        with:
          path: |
            libyaml/
            lua/
          key: "\
            ${{ runner.os }}-\
            ${{ hashFiles('Makefile') }}-\
            ${{ hashFiles('.github/workflows/unit-tests.yaml') }}-\
            ${{ github.ref == 'refs/heads/main' && github.sha || env.DATE }}"
          restore-keys: "\
            ${{ runner.os }}-\
            ${{ hashFiles('Makefile') }}-\
            ${{ hashFiles('.github/workflows/unit-tests.yaml') }}-\

      - name: Build binary
        run: make YL_LDLIBS='-llua -lyaml -lm'

      - name: Run tests
        run: ./test.sh
